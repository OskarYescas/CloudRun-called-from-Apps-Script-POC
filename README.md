# Secure Workspace PDF Generator: Cloud Run x Google Apps Script

**A Proof of Concept (POC) demonstrating a scalable, serverless architecture for offloading complex processing from Google Workspace to Google Cloud Platform.**

> **üí° Note on Native Functionality:** Google Sheets has a built-in "Export to PDF" feature (`File > Download > PDF`) and an export URL endpoint (`/export?format=pdf`).
>
> **Why this project exists:** This solution is designed for scenarios where **native capabilities are insufficient**, such as:
> * Requiring programmatic control over "Fit-to-Page" layout on a per-column basis.
> * Generating reports from datasets too large for client-side processing.
> * **Primary Goal:** To demonstrate how to securely invoke a Google Cloud Run microservice from Apps Script using a "Pull Pattern" architecture.

---

## üèó Architecture: The "Pull Pattern"

This project implements a **"Pass-Through Authentication" + "Data Pull"** workflow to overcome the strict limitations of Google Apps Script.

### The Problem: "Pushing" Data
Google Apps Script's `UrlFetchApp` service has a payload size limit of approximately **50MB**. Attempting to "push" raw cell data from a large Spreadsheet to an external API often results in `Payload Too Large` errors or execution timeouts.

### The Solution: "Pulling" Data
Instead of sending the data, Apps Script sends a **lightweight signal** containing only the `Spreadsheet ID`.
1.  **Signal:** Apps Script sends `{ spreadsheetId: "..." }` and the user's OAuth Token to Cloud Run.
2.  **Validation:** Cloud Run verifies the token and identity.
3.  **Pull:** Cloud Run uses the **Google Sheets API** to fetch the data directly (server-to-server).
4.  **Render & Save:** A Python engine generates the PDF and uploads it directly to the source folder in Google Drive.

---

## üîí Security & Authentication

This project uses a **Zero-Trust Application-Layer Security** model.

* **Service Configuration:** The Cloud Run service is deployed with `"Allow unauthenticated invocations"` (IAM level).
    * *Rationale:* The token generated by `ScriptApp.getOAuthToken()` is a **User Access Token**, not an OIDC Identity Token. Google IAM does not natively validate User Access Tokens for Cloud Run ingress, so we must validate it within the application logic.
* **Token Validation:** The Python service manually validates the `Authorization` header against the Google `userinfo` endpoint.
* **Domain Restriction:** The service enforces an `ALLOWED_DOMAIN` check. If the authenticated user's email does not match the configured organization domain, the request is rejected (401 Unauthorized).
* **Scope:** The service operates with the permissions of the **invoking user** (Pass-Through), ensuring they can only generate reports for files they already have permission to access.

---

## üöÄ Deployment Guide

### Phase 1: Google Cloud Platform (GCP) setup

1.  **Create a Project:** Create a new GCP project with billing enabled.
2.  **Enable APIs:** Navigate to **APIs & Services > Library** and enable:
    * **Cloud Run Admin API**
    * **Google Drive API**
    * **Google Sheets API** (Required for the "Pull" pattern).
3.  **OAuth Consent Screen:**
    * Set type to **Internal** (Workspace only).
    * Add scopes: `.../auth/userinfo.email`, `.../auth/drive`, and `.../auth/spreadsheets`.
4.  **Deploy Cloud Run Service:**
    * Deploy the `main.py` application.
    * **Environment Variable:** Set `ALLOWED_DOMAIN` to your workspace domain (e.g., `example.com`) to restrict access.
    * **Security:** Select "Allow unauthenticated invocations" (see Security section above).
    * **Timeout:** Increase timeout to 300s (5 mins) for large jobs.

### Phase 2: Google Apps Script Configuration

1.  **Open Script Editor:** In your target Google Sheet, go to `Extensions > Apps Script`.
2.  **Project Settings:**
    * Enable "Show 'appsscript.json' manifest file in editor".
    * **Script Properties:** Add a property named `CLOUD_RUN_URL` and paste your Cloud Run service URL.
3.  **Update Manifest (`appsscript.json`):**
    Ensure the following scopes are present to allow token passing and UI interaction.
4.  **Update Code (`Code.gs`):**
    Copy the provided Apps Script logic. This script handles the menu creation, token retrieval, and API signal.

---

## üíª Usage

1.  Refresh your Google Sheet.
2.  Locate the custom menu **"POC PDF"** in the toolbar.
3.  Click **Generate Report**.
4.  Grant permissions (first run only).
5.  Wait for the "Success" modal, then click **OPEN PDF REPORT** or **Open Folder** to view the file.

---

## üìù Good to Know & Limitations

* **Fit-to-Width Logic:** The Python engine (`reportlab`) mathematically calculates column widths based on the visible data to ensure all columns fit within a US Letter Landscape page. It does not simply "shrink" the image; it rebuilds the table structure.
* **Performance:** The backend uses `spreadsheets.values.batchGet` to fetch all tabs in a single API call, significantly reducing latency compared to looping through tabs.
* **Execution Time:** While Cloud Run can handle long processes, Apps Script has a client-side timeout of roughly 6 minutes. The script sets a specific timeout of 180 seconds to fail gracefully if the job is too large.

---

## ‚ö†Ô∏è Disclaimer

This code is provided for **demonstration and Proof of Concept purposes only**. While it utilizes production-grade services, strictly review security settings, IAM roles, and domain restrictions before deploying in a mission-critical environment.