# Secure Workspace PDF Generator: Cloud Run x Google Apps Script

**A Proof of Concept (POC) demonstrating a scalable, serverless architecture for offloading complex processing from Google Workspace to Google Cloud Platform.**

> **üí° Note on Native Functionality:** Google Sheets has a built-in "Export to PDF" feature (`File > Download > PDF`) and an export URL endpoint (`/export?format=pdf`).
>
> **Why this project exists:** This solution is designed for scenarios where **native capabilities are insufficient**, such as:
> * Requiring programmatic control over "Fit-to-Page" layout on a per-column basis.
> * Generating reports from datasets too large for client-side processing.
> [cite_start]* **Primary Goal:** To demonstrate how to securely invoke a Google Cloud Run microservice from Apps Script using a "Pull Pattern" architecture[cite: 84, 103].

---

## üèó Architecture: The "Pull Pattern"

[cite_start]This project implements a **"Pass-Through Authentication" + "Data Pull"** workflow to overcome the strict limitations of Google Apps Script[cite: 13].

### The Problem: "Pushing" Data
[cite_start]Google Apps Script's `UrlFetchApp` service has a payload size limit of approximately **50MB**[cite: 87]. [cite_start]Attempting to "push" raw cell data from a large Spreadsheet to an external API often results in `Payload Too Large` errors or execution timeouts[cite: 88].

### The Solution: "Pulling" Data
Instead of sending the data, Apps Script sends a **lightweight signal** containing only the `Spreadsheet ID`.
1.  [cite_start]**Signal:** Apps Script sends `{ spreadsheetId: "..." }` and the user's OAuth Token to Cloud Run[cite: 16].
2.  [cite_start]**Validation:** Cloud Run verifies the token and identity[cite: 18].
3.  [cite_start]**Pull:** Cloud Run uses the **Google Sheets API** to fetch the data directly (server-to-server)[cite: 7, 19].
4.  [cite_start]**Render & Save:** A Python engine generates the PDF and uploads it directly to the source folder in Google Drive[cite: 20, 21].

---

## üîí Security & Authentication

This project uses a **Zero-Trust Application-Layer Security** model.

* [cite_start]**Service Configuration:** The Cloud Run service is deployed with `"Allow unauthenticated invocations"` (IAM level)[cite: 51].
    * *Rationale:* The token generated by `ScriptApp.getOAuthToken()` is a **User Access Token**, not an OIDC Identity Token. [cite_start]Google IAM does not natively validate User Access Tokens for Cloud Run ingress, so we must validate it within the application logic[cite: 93, 94].
* [cite_start]**Token Validation:** The Python service manually validates the `Authorization` header against the Google `userinfo` endpoint[cite: 97].
* **Domain Restriction:** The service enforces an `ALLOWED_DOMAIN` check. [cite_start]If the authenticated user's email does not match the configured organization domain, the request is rejected (401 Unauthorized)[cite: 98].
* [cite_start]**Scope:** The service operates with the permissions of the **invoking user** (Pass-Through), ensuring they can only generate reports for files they already have permission to access[cite: 10].

---

## üöÄ Deployment Guide

### Phase 1: Google Cloud Platform (GCP) setup

1.  [cite_start]**Create a Project:** Create a new GCP project with billing enabled[cite: 26].
2.  [cite_start]**Enable APIs:** Navigate to **APIs & Services > Library** and enable[cite: 41]:
    * **Cloud Run Admin API**
    * **Google Drive API**
    * [cite_start]**Google Sheets API** (Required for the "Pull" pattern)[cite: 44].
3.  **OAuth Consent Screen:**
    * [cite_start]Set type to **Internal** (Workspace only)[cite: 47].
    * [cite_start]Add scopes: `.../auth/userinfo.email`, `.../auth/drive`, and `.../auth/spreadsheets`[cite: 48].
4.  **Deploy Cloud Run Service:**
    * Deploy the `main.py` application.
    * **Environment Variable:** Set `ALLOWED_DOMAIN` to your workspace domain (e.g., `example.com`) to restrict access.
    * [cite_start]**Security:** Select "Allow unauthenticated invocations" (see Security section above)[cite: 51].
    * [cite_start]**Timeout:** Increase timeout to 300s (5 mins) for large jobs[cite: 53].

### Phase 2: Google Apps Script Configuration

1.  **Open Script Editor:** In your target Google Sheet, go to `Extensions > Apps Script`.
2.  **Project Settings:**
    * Enable "Show 'appsscript.json' manifest file in editor".
    * [cite_start]**Script Properties:** Add a property named `CLOUD_RUN_URL` and paste your Cloud Run service URL[cite: 67, 108].
3.  **Update Manifest (`appsscript.json`):**
    [cite_start]Ensure the following scopes are present to allow token passing and UI interaction[cite: 60]:
    ```json
    "oauthScopes": [
      "[https://www.googleapis.com/auth/script.external_request](https://www.googleapis.com/auth/script.external_request)",
      "[https://www.googleapis.com/auth/drive](https://www.googleapis.com/auth/drive)",
      "[https://www.googleapis.com/auth/spreadsheets](https://www.googleapis.com/auth/spreadsheets)",
      "[https://www.googleapis.com/auth/userinfo.email](https://www.googleapis.com/auth/userinfo.email)",
      "[https://www.googleapis.com/auth/script.container.ui](https://www.googleapis.com/auth/script.container.ui)"
    ]
    ```
4.  **Update Code (`Code.gs`):**
    Copy the provided Apps Script logic. This script handles the menu creation, token retrieval, and API signal[cite: 66].

---

## üíª Usage

1.  Refresh your Google Sheet.
2.  [cite_start]Locate the custom menu **"POC PDF"** in the toolbar[cite: 76].
3.  Click **Generate Report**.
4.  [cite_start]Grant permissions (first run only)[cite: 77].
5.  [cite_start]Wait for the "Success" modal, then click **OPEN PDF REPORT** or **Open Folder** to view the file[cite: 79].

---

## üìù Good to Know & Limitations

* **Fit-to-Width Logic:** The Python engine (`reportlab`) mathematically calculates column widths based on the visible data to ensure all columns fit within a US Letter Landscape page. [cite_start]It does not simply "shrink" the image; it rebuilds the table structure[cite: 101].
* **Performance:** The backend uses `spreadsheets.values.batchGet` to fetch all tabs in a single API call, significantly reducing latency compared to looping through tabs.
* **Execution Time:** While Cloud Run can handle long processes, Apps Script has a client-side timeout of roughly 6 minutes. [cite_start]The script sets a specific timeout of 180 seconds to fail gracefully if the job is too large[cite: 72].

---

## ‚ö†Ô∏è Disclaimer

[cite_start]This code is provided for **demonstration and Proof of Concept purposes only**[cite: 103]. While it utilizes production-grade services, strictly review security settings, IAM roles, and domain restrictions before deploying in a mission-critical environment.
